{% extends 'common/base.html' %}
{% block title %} Stock Transfer | Clarion Stationers {% endblock %}
{% load static %}
{% block content %}
  <!-- To display the messages -->
  <!-- The messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- To let the message disappear after a few seconds -->
  <script>
    setTimeout(function() {
      $('.alert').fadeOut('slow');
    }, 5000);
  </script>

  <div class="container">
    <div class="row">
      <div class="col-md-10 offset-md-1">
        <div class="card mt-5">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h2>Stock Transfer</h2>
              <div>
                <a class="btn btn-secondary rounded mr-2" href="{% url 'accounts:home' %}">
                  <i class="fa fa-chevron-left mr-1"></i>Back to Dashboard
                </a>
              </div>
            </div>
          </div>
          <div class="card-body">
            <form method="post" id="stock-transfer-form">
              {% csrf_token %}
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label for="source_store">Source Store:</label>
                  <select class="form-control" id="source_store" name="source_store" required>
                    <option value="" disabled selected>Transfer From?</option>
                    {% for store in stores %}
                      <option value="{{ store.id }}">{{ store }}</option>
                    {% endfor %}
                  </select>
                </div>
  
                <div class="form-group col-md-6">
                  <label for="destination_store">Destination Store:</label>
                  <select class="form-control" id="destination_store" name="destination_store" required>
                    <option value="" disabled selected>Transfer To?</option>
                    {% for store in stores %}
                      <option value="{{ store.id }}">{{ store }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <hr>

              <h4 class="mb-3">Transfer Items</h4>
              <!-- Display the errors -->
              {% for transfer_item_error in transfer_item_errors %}
                <div class="alert alert-danger">{{ transfer_item_error }}</div>
              {% endfor %}

              <div class="table-responsive">
                <table class="table" id="transfer-items-table">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Quantity</th>
                      <th>Unit</th>
                      <th></th>  <!-- Empty header for remove button -->
                    </tr>
                  </thead>
                  <tbody id="transfer-item-formset">
                    <!-- This tbody will be dynamically populated with transfer item rows -->
                  </tbody>
                </table>
              </div>

              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <a class="btn btn-warning rounded mr-2" href="{% url 'sales:sales' %}">
                    <i class="fa fa-money mr-1"></i>Make Sale Instead
                  </a>
                </div>
                <div>
                  <button type="button" class="btn btn-primary mt-3" id="add-transfer-item">
                    <i class="fa fa-plus mr-2" style="font-size: 20px;"></i>
                    Add Transfer Item
                  </button>
                </div>
              </div>
              

              <hr>

              <button type="submit" class="btn btn-success btn-block">Transfer</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Transfer Items Modal -->
  <div class="modal fade" id="transferItemsModal" tabindex="-1" role="dialog" aria-labelledby="transferItemsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transferItemsModalLabel">Clarion Stationers Stock Transfer</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
          <div class="d-flex justify-content-center align-items-center flex-column">
            <img src="{% static 'images/logos/clarion_logo.svg' %}" alt="Logo" style="width: 60px; height: 60px;">
            
            <!-- Store names -->
            <div class="store-names" style="display: block; justify-content: space-between; width: 100%;">
              <!-- Store names will be dynamically populated here -->
            </div>
          </div>

          <!-- Receipt details -->
          <table class="table" style="margin-top: 20px; margin-left: auto; margin-right: auto;">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Unit</th>
              </tr>
            </thead>
            <tbody id="transfer-items-modal-body">
              <!-- This tbody will be dynamically populated with transfer item rows -->
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="print-receipt">Print</button>
        </div>
        
      </div>
    </div>
  </div>



  <script>
    $(document).ready(function() {
      var formset = $('#transfer-item-formset'); // Container for transfer item formset
      var productCounter = 0; // Counter for unique product field names
  
      // Function to add a transfer item row
      function addTransferItem() {
        var transferItemRow = `
          <tr>
            <td>
              <select class="form-control" id="product_${productCounter}" name="product" required>
                <option value="" disabled selected>Select a product</option>
                {% for product in products %}
                  <option value="{{ product.id }}" data-product-name="{{ product.name }}">{{ product }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <input type="number" class="form-control" id="quantity_${productCounter}" name="quantity" placeholder="Enter quantity" required>
            </td>
            <td>
              <select class="form-control" id="unit_${productCounter}" name="unit" required>
                <option value="" disabled selected>Select a unit</option>
                <option value="pieces">Pieces</option>
                <option value="cartons">Cartons</option>
              </select>
            </td>
            <td>
              <button type="button" class="btn btn-danger btn-sm remove-transfer-item">Remove</button>
            </td>
          </tr>
        `;
        formset.append(transferItemRow);
        productCounter++;
      }
  
      // Function to remove a transfer item row
      function removeTransferItem() {
        $(this).closest('tr').remove();
        productCounter--;
      }
  
      // Add transfer item on button click
      $('#add-transfer-item').click(function() {
        addTransferItem();
      });
  
      // Remove transfer item on button click (event delegation)
      $(document).on('click', '.remove-transfer-item', removeTransferItem);
  
      // Show transfer items modal on button click
      $('#view-transfer-items').click(function() {
        var transferItems = [];
  
        // Collect transfer item data
        $('#transfer-items-table tbody tr').each(function(index) {
          var product = $(this).find('select[name="product"]').val();
          var quantity = parseInt($(this).find('input[name="quantity"]').val());
          var unit = $(this).find('select[name="unit"]').val();
  
          transferItems.push({
            product: product,
            quantity: quantity,
            unit: unit
          });
        });
  
        
      });
  
      // Perform form submission via AJAX
      $('#stock-transfer-form').on('submit', function(event) {
        event.preventDefault(); // Prevent default form submission
  
        var sourceStore = $('#source_store').val();
        var destinationStore = $('#destination_store').val();
        var transferItems = [];
  
        // Collect transfer item data
        $('#transfer-items-table tbody tr').each(function(index) {
          var product = $(this).find('select[name="product"]').val();
          var quantity = parseInt($(this).find('input[name="quantity"]').val());
          var unit = $(this).find('select[name="unit"]').val();
  
          transferItems.push({
            product: product,
            quantity: quantity,
            unit: unit
          });
        });
  
        // Check if the quantity exceeds available stock in the source store
        for (var i = 0; i < transferItems.length; i++) {
          var transferItem = transferItems[i];
  
          if (transferItem.quantity <= 0) {
            $('#error-message').text('Quantity must be greater than zero.');
            return;
          }
  
          if (transferItem.unit === 'pieces') {
            // Quantity is in pieces, no conversion needed
            var sourceStockQuantity = parseInt($('#stock_quantity_' + transferItem.product).val());
          } else if (transferItem.unit === 'cartons') {
            // Quantity is in cartons, convert to pieces
            var piecesPerCarton = parseInt($('#pieces_per_carton_' + transferItem.product).val());
            var sourceStockQuantity = parseInt($('#stock_quantity_' + transferItem.product).val()) * piecesPerCarton;
          }
  
          if (transferItem.quantity > sourceStockQuantity) {
            $('#error-message').text('Transfer quantity exceeds the available stock in the source store.');
            return;
          }
        }
  
        if (sourceStore === destinationStore) {
          // Show error message
          $('#error-message').text('Source and destination stores must be different.');
        } else {
          // Clear error message
          $('#error-message').text('');
  
          // Prepare data for AJAX submission
          var formData = $(this).serializeArray();
          formData.push({ name: 'transfer_items', value: JSON.stringify(transferItems) });
  
          // Submit the form via AJAX
          $.ajax({
            url: $(this).attr('action'),
            type: $(this).attr('method'),
            data: formData,
            success: function(response) {
              // Handle success response
              if (response.success) {
                // Show success message
                $('#success-message').text(response.message);
  
                // Clear the form
                $('#stock-transfer-form')[0].reset();
  
                // Remove transfer item rows
                $('#transfer-item-formset').empty();
              } else {
                // Show error message
                $('#error-message').text(response.message);
              }
            },
            error: function(xhr, status, error) {
              // Handle error response
              console.error(xhr.responseText);
            }
          });

          // Populate transfer items modal body
          var modalBody = $('#transfer-items-modal-body');
          modalBody.empty();
    
          // Display store names
          var sourceStoreName = $('#source_store option:selected').text();
          var destinationStoreName = $('#destination_store option:selected').text();
          var storeNamesHtml = `
            <div class="row">
              <div class="col-md-6">
                <p style="margin: 0; text-align: left;">Source store: ${sourceStoreName}</p>
              </div>
              <div class="col-md-6">
                <p style="margin: 0; text-align: right;">Destination store: ${destinationStoreName}</p>
              </div>
            </div>
          `;
          $('.store-names').prepend(storeNamesHtml);
    
          // Display transfer item details
          for (var i = 0; i < transferItems.length; i++) {
            var transferItem = transferItems[i];
            var productName = document.querySelector(`[value="${transferItem.product}"]`).getAttribute('data-product-name');
            var transferItemRow = `
              <tr>
                <td>${productName}</td>
                <td>${transferItem.quantity}</td>
                <td>${transferItem.unit}</td>
              </tr>
            `;
            modalBody.append(transferItemRow);
          }
    
          // Show the transfer items modal
          $('#transferItemsModal').modal('show');

          // Print receipt on button click
          $(document).on('click', '#print-receipt', function() {
            // Create a new window for printing
            var printWindow = window.open('', '_blank');

            // Build the content of the print window
            var receiptContent = `
              <html>
                <head>
                  <title>Clarion Stationers | Stock Transfer</title>
                  <style>
                    body {
                      font-family: Arial, sans-serif;
                      margin: 20px;
                    }
                    .logo {
                      text-align: center;
                      margin-bottom: 20px;
                    }
                    .store-names {
                      margin-bottom: 10px;
                    }
                    table {
                      width: 100%;
                      border-collapse: collapse;
                    }
                    table td, table th {
                      padding: 8px;
                      text-align: left;
                      border-bottom: 1px solid #ddd;
                    }
                    table th {
                      background-color: #f2f2f2;
                    }
                  </style>
                </head>
                <body>
                  <div class="logo">
                    <img src="{% static 'images/logos/clarion_logo.svg' %}" alt="Logo" style="width: 65px; height: 65px;">
                  </div>
                  <div class="store-names">
                    <div style="text-align: left;">Source store: ${sourceStoreName}</div>
                    <div style="text-align: right;">Destination store: ${destinationStoreName}</div>
                  </div>
                  <table>
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${$('#transfer-items-modal-body').html()}
                    </tbody>
                  </table>
                </body>
              </html>
            `;

            printWindow.document.write(receiptContent);
            printWindow.document.close();

            // Print the receipt after the image is loaded (to ensure proper rendering)
            printWindow.addEventListener('load', function() {
              printWindow.print();
            });
          }); // end of print modal


        }

      });

      // End of document
    });
  </script>
  
{% endblock %}
