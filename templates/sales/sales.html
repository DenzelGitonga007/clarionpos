{% extends 'common/base.html' %}
{% load static %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-9">
            <h4>Sales by {{ request.user.username }} for {{ request.user.store }}</h4>
        </div>
        <div class="col-md-3 text-right">
            <a class="btn btn-secondary rounded mr-2" href="{% url 'accounts:home' %}">
                <i class="fa fa-chevron-left mr-1"></i>Back to Home
            </a>
        </div>
    </div>
    <hr>
    <div class="row">
        <!-- Products -->
        <div class="col-md-8">
            <div class="card">
            <div class="card-header">
                <h5>Products</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped table-responsive">
                <thead>
                    <tr>
                    <th>Name</th>
                    <th>Product Price</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="product-entries">
        
                </tbody>
                </table>
                <!-- Add another product -->
                <div class="text-right">
                <button class="btn btn-warning" id="add-product-button" onclick="addProductEntry()">Add Product</button>
                </div>
            </div>
            </div>
        </div>
  
        <!-- Cart -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Cart</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-responsive">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="cart-items">
                            <!-- Cart items will be dynamically added here -->
                        </tbody>
                    </table>
                    <h5>Total Amount: <span id="total-amount">0.00</span></h5>
                    <hr>
                    <div class="text-right">
                        <button class="btn btn-success" data-toggle="modal" data-target="#saleModal">Submit Sale</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sale Modal -->
<div class="modal fade" id="saleModal" tabindex="-1" role="dialog" aria-labelledby="saleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saleModalLabel">Submit Sale</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Select Customer -->
                <div class="form-group">
                    <label for="customer">Select a Customer</label>
                    <select class="form-control" id="customer-select" required>
                        <option value="" disabled selected>Sell to?</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- End of select customer -->
                <!-- Rendered amount -->
                <div class="form-group">
                    <label for="rendered-amount">Rendered Amount:</label>
                    <input type="number" class="form-control" id="rendered-amount" step="0.01" placeholder="Enter the rendered amount" name="rendered_amount">
                </div>
                <!-- End of rendered amount -->
                <!-- Balance -->
                <div class="form-group">
                    <label for="balance">Balance:</label>
                    <input type="number" class="form-control" name="balance" id="balance" step="0.01" disabled>
                </div>
                <!-- End of balance -->
                <!-- Select payment method -->
                <div class="form-group">
                    <label for="payment_method">Select Payment Method</label>
                    <select class="form-control" id="payment_method-select" required>
                        <option value="" disabled selected>Pay Via?</option>
                        {% for method in payment_methods %}
                        <option value="{{ method.id }}">{{ method.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- End of payment method -->

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitSale()">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- Receipt modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" role="dialog" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">Receipt</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <div class="receipt-details">
                    <!-- Receipt content goes here -->
                    <!-- Display customer details, amounts, products, balance, etc. -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printReceiptBtn">Print Receipt</button>
            </div>
        </div>
    </div>
</div>


<!-- Javascript -->
<script>
    // Function to add another product entry
    function addProductEntry() {
        var productEntries = document.getElementById("product-entries");

        // Create a new row for the product entry
        var newRow = document.createElement("tr");
        newRow.innerHTML = `
            <tr class="product-entry">
                <td>
                    <div class="input-group">
                        <select class="form-control product-select" required onchange="updatePrice(this)">
                            <option value="" disabled selected>Select a product</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" data-price="{{ product.price }}" data-pieces-per-carton="{{ product.pieces_per_carton }}">{{ product.name }}</option>
                            {% endfor %}
                        </select>
                        <!-- Error -->
                        <div class="error-message-product text-danger"></div>
                    </div>
                </td>
                <td>
                    <div class="input-group">
                        <input type="number" class="form-control price-input" id="price-input-${productEntries.childElementCount}" step="0.01">
                        <div class="price-error invalid-feedback" id="price-error"></div>
                        <!-- Error -->
                        <div class="error-message-price text-danger"></div>
                    </div>
                </td>

            <td>
                <input type="number" class="form-control quantity-input" min="0">
                <!-- Error -->
                <div class="error-message-quantity text-danger"></div>
            </td>
            <td>
                <select class="form-control unit-select">
                    <option value="" disabled selected>Select a unit</option>
                    {% for unit_value, unit_name in units %}
                    <option value="{{ unit_value }}">{{ unit_name }}</option>
                    {% endfor %}
                </select>
            </td>

            <td>
                <button class="btn btn-primary btn-sm" onclick="addToCart(this)">Add to Cart</button>
            </td>
            </tr>
        `;

        // Add the new row to the product entries table
        productEntries.appendChild(newRow);
    }

    // Update the price of the selected product
    function updatePrice(selectElement) {
        var selectedOption = selectElement.options[selectElement.selectedIndex];
        var priceInput = selectElement.closest("tr").querySelector(".price-input");
        var price = parseFloat(selectedOption.getAttribute("data-price"));

        // Set the price input value
        priceInput.value = price.toFixed(2); 
    }


    // Function to add the selected product to the cart
    function addToCart(button) {
        var productEntry = button.closest("tr");
        var selectedProduct = productEntry.querySelector(".product-select");
        var selectedOption = selectedProduct.options[selectedProduct.selectedIndex];
        var productName = selectedOption.text;
        var priceInput = productEntry.querySelector(".price-input");
        var quantityInput = productEntry.querySelector(".quantity-input");
        var unitSelect = productEntry.querySelector(".unit-select");
        var selectedUnit = unitSelect.options[unitSelect.selectedIndex].text;
        var price = parseFloat(priceInput.value);
        var quantity = parseInt(quantityInput.value);
        var errorContainerProduct = productEntry.querySelector(".error-message-product");
        var errorContainerPrice = productEntry.querySelector(".error-message-price");
        var errorContainerQuantity = productEntry.querySelector(".error-message-quantity");

        // Reset error messages
        errorContainerProduct.textContent = "";
        errorContainerPrice.textContent = "";
        errorContainerQuantity.textContent = "";

        // Perform any necessary validations here
        if (selectedOption.value === "") {
            errorContainerProduct.textContent = "Please select a product.";
            return;
        }
        if (priceInput.value.trim() === "") {
            errorContainerPrice.textContent = "Please enter a price.";
            return;
        }
        if (quantityInput.value.trim() === "") {
            errorContainerQuantity.textContent = "Please enter a quantity.";
            return;
        }
        if (quantity <= 0) {
            errorContainerQuantity.textContent = "Quantity must be greater than zero.";
            return;
        }
        if (price < parseFloat(selectedOption.getAttribute("data-price"))) {
            errorContainerPrice.textContent = "Price cannot be lower than the set price for the product. The set price is " + selectedOption.getAttribute("data-price");
            return;
        }

        // Check if the product already exists in the cart
        var cartItems = document.getElementById("cart-items");
        var cartRows = cartItems.querySelectorAll("tr");
        for (var i = 0; i < cartRows.length; i++) {
            var cartProduct = cartRows[i].querySelector("td:first-child").textContent;
            if (cartProduct === productName) {
                errorContainerProduct.textContent = "Product already exists in the cart.";
                return;
            }
        }

        // Calculate the total amount for the item
        var total;
        if (selectedUnit === "Cartons") {
            var piecesPerCarton = parseFloat(selectedOption.getAttribute("data-pieces-per-carton"));
            total = (piecesPerCarton * quantity * price).toFixed(2);
        } else {
            total = (price * quantity).toFixed(2);
        }

        // Create a new row for the cart item
        var newRow = document.createElement("tr");
        newRow.innerHTML = `
            <td>${productName}</td>
            <td>${price.toFixed(2)}</td>
            <td>${quantity}</td>
            <td>${selectedUnit}</td>
            <td>${total}</td>
            <td><button class="btn btn-danger btn-sm" onclick="removeCartItem(this)">Remove</button></td>
        `;

        // Add the new row to the cart items table
        cartItems.appendChild(newRow);

        // Update the total amount
        updateTotalAmount();
    }

    // Function to remove a cart item
    function removeCartItem(button) {
        var row = button.closest("tr");
        row.parentNode.removeChild(row);

        // Update the total amount
        updateTotalAmount();
    }

    // Function to update the total amount
    function updateTotalAmount() {
        var totalAmount = 0.00;
        var cartItems = document.getElementById("cart-items").getElementsByTagName("tr");

        // Loop through each cart item and calculate the total amount
        for (var i = 0; i < cartItems.length; i++) {
            var item = cartItems[i];
            var totalCell = item.cells[4];
            var total = parseFloat(totalCell.textContent);
            totalAmount += total;
        }

        // Update the total amount display
        var totalAmountElement = document.getElementById("total-amount");
        totalAmountElement.textContent = totalAmount.toFixed(2);
    }


    // Function to submit the sale
    function submitSale() {
        var cartItems = document.getElementById("cart-items").getElementsByTagName("tr");
        var saleItems = [];

        // Loop through each cart item and collect the sale item data
        for (var i = 0; i < cartItems.length; i++) {
            var item = cartItems[i];
            var productName = item.cells[0].innerHTML;
            var price = parseFloat(item.cells[1].innerHTML);
            var quantity = parseInt(item.cells[2].innerHTML);
            var unit = item.cells[3].innerHTML.trim();
            var total = parseFloat(item.cells[4].innerHTML);

            // Create a sale item object
            var saleItem = {
                productName: productName,
                price: price,
                quantity: quantity,
                unit: unit,
                total: total
            };

            // Add the sale item to the sale items array
            saleItems.push(saleItem);
        }

        // Retrieve the rendered amount from the input field
        var renderedAmount = parseFloat(document.getElementById("rendered-amount").value);

        // Retrieve the customer ID from the select field
        var customerId = parseInt(document.getElementById("customer-select").value);

        // Retrieve the payment method
        var payment_methodId = parseInt(document.getElementById("payment_method-select").value);

        // Retrieve the balance from the balance input field
        var balance = updateBalance();

        // Create a sale object
        var sale = {
            saleItems: saleItems,
            renderedAmount: renderedAmount,
            customerId: customerId,
            payment_methodId: payment_methodId,
            balance: balance
        };

        // Prepare the CSRF token
        var csrftoken = getCookie('csrftoken');

        // Create the AJAX request
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/sales/submit_sale/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', csrftoken);

        // Handle the response
        xhr.onload = function () {
            if (xhr.status === 200) {
                // Close the modal
                $('#saleModal').modal('hide');

                // Display the receipt modal
                $('#receiptModal').modal('show');

                // Retrieve the soldBy value (logged-in user) from the server-side
                var soldBy = "{{ request.user.username }}";

                // Populate the receipt modal with necessary data
                var receiptModalBody = document.getElementById('receiptModal').querySelector('.modal-body');
                receiptModalBody.innerHTML = createReceiptContent(soldBy);

                // Display a success message or perform any other desired actions
                alert("Sale submitted successfully.");

                // Handle receipt modal close event
                $('#receiptModal').on('hidden.bs.modal', function () {
                    // Reset the product entries
                    var productEntries = document.getElementById("product-entries");
                    productEntries.innerHTML = ""; // Clear the product entries

                    // Reset the cart by clearing the cart items
                    var cartItemsElement = document.getElementById("cart-items");
                    cartItemsElement.innerHTML = "";

                    // Reset the total amount
                    var totalAmountElement = document.getElementById("total-amount");
                    totalAmountElement.textContent = "0.00";

                    // Reset the rendered amount and balance
                    var renderedAmountInput = document.getElementById("rendered-amount");
                    renderedAmountInput.value = "";

                    var balanceInput = document.getElementById("balance");
                    balanceInput.value = "";
                });
            } else {
                // Handle the error case
                alert("Failed to submit the sale. Please try again.");
            }
        };

        // Convert the sale object to JSON and send the request
        var data = JSON.stringify(sale);
        xhr.send(data);
    }

    // Receipt function
    function createReceiptContent(soldBy) {
        var receiptContent = '<div style="text-align: center;">';
        receiptContent += '<img src="{% static 'images/logos/clarion_logo.svg' %}" alt="Logo" style="width: 60px; height: 60px;">'; //
        receiptContent += '<h4 style="margin-top: 20px;">Clarion Stationers Receipt</h4>';

        var cartItems = document.getElementById("cart-items").getElementsByTagName("tr");

        // Display customer details
        var customerName = document.getElementById("customer-select").options[document.getElementById("customer-select").selectedIndex].text;
        receiptContent += '<p><strong>Customer:</strong> ' + customerName + '</p>';

        // Display the payment method
        var paymentMethod = document.getElementById("payment_method-select").options[document.getElementById("payment_method-select").selectedIndex].text;
        receiptContent += '<p><strong>Payment Method:</strong> ' + paymentMethod + '</p>';

        // Display sale items
        receiptContent += '<table class="table" style="margin-top: 20px; margin-left: auto; margin-right: auto;">';
        receiptContent += '<thead><tr><th>Product</th><th>Quantity</th><th>Unit</th><th>Price</th><th>Total</th></tr></thead>';
        receiptContent += '<tbody>';
        for (var i = 0; i < cartItems.length; i++) {
            var item = cartItems[i];
            var productName = item.cells[0].innerHTML;
            var quantity = parseInt(item.cells[2].innerHTML);
            var unit = item.cells[3].innerHTML.trim();
            var price = parseFloat(item.cells[1].innerHTML);
            var total = parseFloat(item.cells[4].innerHTML);

            receiptContent += '<tr>';
            receiptContent += '<td style="text-align: center;">' + productName + '</td>';
            receiptContent += '<td style="text-align: center;">' + quantity + '</td>';
            receiptContent += '<td style="text-align: center;">' + unit + '</td>';
            receiptContent += '<td style="text-align: center;">' + price.toFixed(2) + '</td>';
            receiptContent += '<td style="text-align: center;">' + total.toFixed(2) + '</td>';
            receiptContent += '</tr>';
        }
        receiptContent += '</tbody>';
        receiptContent += '</table>';

        // Display total amount
        var totalAmount = parseFloat(document.getElementById("total-amount").textContent);
        receiptContent += '<p><strong>Total Amount:</strong> ' + totalAmount.toFixed(2) + '</p>';

        // Retrieve the rendered amount and balance
        var renderedAmount = parseFloat(document.getElementById("rendered-amount").value);
        var balance = parseFloat(document.getElementById("balance").value);

        // Display rendered amount and balance
        receiptContent += '<p><strong>Amount Rendered:</strong> ' + renderedAmount.toFixed(2) + '</p>';
        receiptContent += '<p><strong>Balance:</strong> ' + balance.toFixed(2) + '</p>';

        // Display sold by
        receiptContent += '<p><strong>Sold By:</strong> ' + soldBy + '</p>';

        receiptContent += '</div>';

        return receiptContent;
    }

    // Printing the receipt
    document.getElementById("printReceiptBtn").addEventListener("click", function() {
        printReceipt();
    });


    function printReceipt() {
        var soldBy = "{{ request.user.username }}";

        var receiptContent = createReceiptContent(soldBy);

        var printWindow = window.open("", "_blank");
        printWindow.document.open();
        printWindow.document.write('<html><head><title>Clarion Stationers Receipt</title></head><body>');
        printWindow.document.write(receiptContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }


    // Function to calculate and update the balance
    function updateBalance() {
        var renderedAmountInput = document.getElementById("rendered-amount");
        var renderedAmount = parseFloat(renderedAmountInput.value);
        var totalAmount = parseFloat(document.getElementById("total-amount").textContent);
        var balanceInput = document.getElementById("balance");

        var balance = renderedAmount - totalAmount;
        balanceInput.value = balance.toFixed(2);

        return balance.toFixed(2);
    }

    // Add an event listener to the rendered amount input to update the balance on input change
    var renderedAmountInput = document.getElementById("rendered-amount");
    renderedAmountInput.addEventListener("input", updateBalance);

    // Function to retrieve the value of a cookie by its name
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
<!-- End of Javascript -->

{% endblock %}
